<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
    
  <meta name="description" content="一个心中空有一万个理想，却只有三分钟的热度" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    TCP详解 |  zdzhong
  </title>
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/css/style.css">
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
<script src="/js/pace.min.js"></script>


  

  

<meta name="generator" content="Hexo 4.1.0"><link rel="alternate" href="/atom.xml" title="zdzhong" type="application/atom+xml">
</head>

</html>

<body>
  <div id="app">
    <main class="content">
      <section class="outer">
  <article id="post-TCP详解" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  TCP详解
</h1>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/10/TCP%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time datetime="2020-01-10T03:28:17.000Z" itemprop="datePublished">2020-01-10</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a>
  </div>

    </div>
    

    
    
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>&ensp; 传输控制协议（TCP，Transmission Control Protocol）是一种面向连接的、可靠的、基于字节流的传输层通信协议，为用户进程提供可靠的全双工字节流。位于计算机网络五层体系结构（物理层、数据链路层、网络层、运输层、应用层）中的运输层。  </p>
<h3 id="TCP数据包的组成"><a href="#TCP数据包的组成" class="headerlink" title="TCP数据包的组成"></a>TCP数据包的组成</h3><p>&ensp; 首先看一下tcp报文的头部： </p>
<a id="more"></a>   
<p><img src="/2020/01/10/TCP%E8%AF%A6%E8%A7%A3/tcp01.png" alt>  </p>
<p>&ensp; <strong>16位的源端口号与16位的目的端口号</strong><br>用于寻找发送端和目的端应用进程。当然这只能用来确认某个主机中的进程，但是无法确认是哪一个主机，这个艰巨的任务就交由网络层的ip协议。  </p>
<p>&ensp; <strong>32位的序号</strong><br>TCP会话的每一端都包含一个32位（bit）的序列号，该序列号被用来跟踪发送端发送的数据量。在刚建立的的时候该值为随机值（随机算法：ISN=M + F(localhost, localport, remotehost, remoteport)，M是一个计时器，这个计时器每隔4毫秒加1。F是一个Hash算法，根据源IP、目的IP、源端口、目的端口生成一个随机数值。要保证hash算法不能被外部轻易推算得出），以后再将每次成功转发过去的<strong>字节数</strong>累加到初始值上表示数据的位置。每一个包中都包含序列号，在接收端则通过确认号用来通知发送端数据成功接收。  </p>
<p>&ensp; <strong>32位的确认序号</strong><br>这个确认序号用来表示为当前端从建立连接开始到目前接收的数据位数+1。（表示下一次应该收到的数据位置，发送端收到这个确认应答以后可以认为在这个序号以前的数据都已经被正常接收）  </p>
<p>&ensp; <strong>4位的偏移量</strong><br>数据偏移量也叫首部长度，用于记录tcp数据报首部的长度，一般为20字节，实际值为首部长度除以4。  </p>
<p>&ensp; <strong>标志位</strong><br>标志位字段长为6，每一位从左到右分别为：URG、ACK、PSH、RST、SYN、FIN。当对应的值为1，表示有具体含义:<br>URG:紧急指针是否有效。为1，表示某一位需要被优先处理。<br>ACK:确认号是否有效，一般置为1。<br>PSH:提示接收端应用程序立即从TCP缓冲区把数据读走。<br>RST :对方要求重新建立连接，复位。<br>SYN:为1表示请求建立连接，并在其序列号的字段进行序列号的初始值设定。<br>FIN:希望断开连接。  </p>
<p>&ensp; <strong>16位的窗口大小</strong><br>接收缓冲区的大小，TCP不允许发送超过此处所示大小的数据。  </p>
<p>&ensp; <strong>16位的校验和</strong><br>发送端填充，CRC校验，接收校验不通过，则认为数据有问题。和UDP的区别是，UDP校验的是数据本身，TCP校验的不仅包含TCP首部，而且包含TCP数据部分。  </p>
<p>&ensp; <strong>16位的紧急指针</strong><br>只有在URG为1时有效，该字段为1表示本报文的段中的紧急数据的指针。  </p>
<h3 id="三次握手建立连接"><a href="#三次握手建立连接" class="headerlink" title="三次握手建立连接"></a>三次握手建立连接</h3><p>&ensp; 第一次握手，客户端会发送一个标志位SYN=1（表示请求建立连接），序列号（seq）=X（随机生成的初始化值）的数据包给服务端主机。  </p>
<p>&ensp; 第二次握手，服务端收到客户端的建立连接请求，会发送一个标志位SYN=1,ACK=1，序列号（seq）=Y，确认序列号（ack）=X+1的数据包给客户端。  </p>
<p>&ensp; 第三次握手，当客户端收到数据包之后，知道了之前序列号=X的数据包已经被服务端收到，但是此时，服务端还不知道客户端有没有收到自己的确认包，所以，客户端会再次发送一个数据包，用来通知服务端自己已经收到它的确认包了，所以这个包里面的标志位只有ACK=1，表示确认包，并且序列号=X+1，确认号=Y+1，为什么都是+1 ？因为这三个包是特殊的包，专门用来建立连接的，所以并没有真实的有效数据，如果有有效数据，则还需要加上接收到的数据长度。此包发送完毕，客户端和服务器进入ESTAB_LISHED(TCP连接成功)状态，完成三次握手，接下来就可以传输数据了。<br>&ensp; <strong>第三次握手的报文是可以携带有效数据的</strong>，下面是一张tcp建立连接-传输数据-关闭连接图<br><img src="/2020/01/10/TCP%E8%AF%A6%E8%A7%A3/tcp02.png" alt></p>
<p>&ensp; <strong>为什么时三次握手，两次不行吗？</strong><br>如客户端发出连接请求，但因连接请求报文丢失而未收到确认，于是客户端再重传一次连接请求。后来收到了确认，建立了连接。数据传输完毕后，就释放了连接，客户端共发出了两个连接请求报文段，其中第一个丢失，第二个到达了服务端，但是第一个丢失的报文段只是在某些网络结点长时间滞留了，延误到连接释放以后的某个时间才到达服务端，此时服务端误认为客户端又发出一次新的连接请求，于是就向客户端发出确认报文段，同意建立连接，不采用三次握手，只要服务端发出确认，就建立新的连接了，此时客户端忽略服务端发来的确认，也不发送数据，则服务端一致等待客户端发送数据，浪费资源。  </p>
<p>&ensp; <strong>什么是半连接队列？</strong><br>服务器第一次收到客户端的 SYN 之后，就会处于 SYN_RCVD  状态，此时双方还没有完全建立其连接，服务器会把此种状态下请求连接放在一个队列里，我们把这种队列称之为半连接队列。  </p>
<p>当然还有一个全连接队列，就是已经完成三次握手，建立起连接的就会放在全连接队列中。如果队列满了就有可能会出现丢包现象。  </p>
<p>这里在补充一点关于SYN-ACK 重传次数的问题：</p>
<p>服务器发送完SYN-ACK包，如果未收到客户确认包，服务器进行首次重传，等待一段时间仍未收到客户确认包，进行第二次重传。如果重传次数超过系统规定的最大重传次数，系统将该连接信息从半连接队列中删除。</p>
<p>注意，每次重传等待的时间不一定相同，一般会是指数增长，例如间隔时间为 1s，2s，4s，8s…  </p>
<p>&ensp; <strong>SYN攻击是什么？</strong><br>服务器端的资源分配是在二次握手时分配的，而客户端的资源是在完成三次握手时分配的，所以服务器容易受到SYN洪泛攻击。SYN攻击就是Client在短时间内伪造大量不存在的IP地址，并向Server不断地发送SYN包，Server则回复确认包，并等待Client确认，由于源地址不存在，因此Server需要不断重发直至超时，这些伪造的SYN包将长时间占用未连接队列，导致正常的SYN请求因为队列满而被丢弃，从而引起网络拥塞甚至系统瘫痪。SYN 攻击是一种典型的 DoS/DDoS 攻击。  </p>
<h3 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h3><p>建立一个连接需要三次握手，而终止一个连接要经过四次挥手，这由TCP的半关闭造成的。所谓的半关闭，其实就是TCP提供了连接的一端在结束它的发送后还能接收来自另一端数据的能力。  </p>
<p>&ensp; 第一次挥手，客户端发送一个 FIN 报文，报文中会指定一个序列号。即发出连接释放报文段（FIN=1，序号seq=u），并停止再发送数据，主动关闭TCP连接，等待服务端的确认。  </p>
<p>&ensp; 第二次挥手，服务端收到 FIN 之后，会发送 ACK 报文，且把客户端的序列号值 +1 作为 ACK 报文的序列号值，表明已经收到客户端的报文了。即服务端收到连接释放报文段后即发出确认报文段（ACK=1，确认号ack=u+1，序号seq=v），此时的TCP处于半关闭状态，客户端到服务端的连接释放。  </p>
<p>&ensp; 第三次挥手，如果服务端也想断开连接了，和客户端的第一次挥手一样，发给 FIN 报文，且指定一个序列号。即服务端没有要向客户端发出的数据，服务端发出连接释放报文段（FIN=1，ACK=1，序号seq=w，确认号ack=u+1），等待客户端的确认。  </p>
<p>&ensp; 第四次挥手，客户端收到FIN之后，一样发送一个ACK报文作为应答，且把服务端的序列号值 +1 作为自己ACK报文的序列号值，需要过一阵子以确保服务端收到自己的ACK报文之后才会关闭连接，服务端收到 ACK 报文之后，就处于关闭连接了。即客户端收到服务端的连接释放报文段后，对此发出确认报文段（ACK=1，seq=u+1，ack=w+1）。此时TCP未释放掉，需要经过时间等待计时器设置的时间2MSL后，客户端才关闭连接。  </p>
<p>&ensp; <strong>挥手为什么需要四次</strong><br>因为当服务端收到客户端的SYN连接请求报文后，可以直接发送SYN+ACK报文。其中ACK报文是用来应答的，SYN报文是用来同步的。但是关闭连接时，当服务端收到FIN报文时，很可能并不会立即关闭SOCKET，所以只能先回复一个ACK报文，告诉客户端，“你发的FIN报文我收到了”。只有等到我服务端所有的报文都发送完了，我才能发送FIN报文，因此不能一起发送。故需要四次挥手。  </p>
<p>&ensp; <strong>四次挥手释放连接时，等待2MSL的意义?</strong><br>每个具体TCP实现必须选择一个报文段最大生存时间MSL(Maximum Segment Lifetime)。它是任何报文段被丢弃前在网络内的最长时间。我们知道这个时间是有限的，因为TCP报文段以IP数据报在网络内传输，而IP数据报则有限制其生存时间的TTL字段。<br>对一个具体实现所给定的MSL值，处理的原则是：当TCP执行一个主动关闭，并发回最后一个ACK，该连接必须在TIME_WAIT状态停留的时间为2倍的MSL。这样可让TCP再次发送最后的ACK以防这个ACK丢失(<strong>另一端超时并重发最后的FIN</strong>)。</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/10/TCP%E8%AF%A6%E8%A7%A3/" data-id="ck5c6t3vy0002g4na3qpih6qs"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tcp/" rel="tag">tcp</a></li></ul>

    </footer>

  </div>

  
  
  <nav class="article-nav">
    
      <a href="/2020/01/13/CompletableFuture%E7%9A%84%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            CompletableFuture的实际应用
          
        </div>
      </a>
    
    
      <a href="/2020/01/07/%E7%BA%A2%E9%BB%91%E6%A0%91/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">红黑树</div>
      </a>
    
  </nav>


  

  
  
<!-- valine评论 -->
<div id="vcomments-box">
    <div id="vcomments">
    </div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine@1.3.10/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        app_id: 'chaSYi8FMdJBwzIBpxeNjqWC-gzGzoHsz',
        app_key: 'PqqkLYgPkHvH1BmyQqySWnSK',
        path: window.location.pathname,
        avatar: 'mp',
        placeholder: '给我的文章加点评论吧~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }
</script>
<style>
    #vcomments-box {
        padding: 5px 30px;
    }

    @media screen and (max-width: 800px) {
        #vcomments-box {
            padding: 5px 0px;
        }
    }

    #vcomments-box #vcomments {
        background-color: #fff;
    }

    .v .vlist .vcard .vh {
        padding-right: 20px;
    }

    .v .vlist .vcard {
        padding-left: 10px;
    }
</style>

  

  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2015-2020
        zdzhong
      </li>
      <li>
        
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a> by shenyu
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
        
        <ul class="list-inline">
  <li>PV:<span id="busuanzi_value_page_pv"></span></li>
  <li>UV:<span id="busuanzi_value_site_uv"></span></li>
</ul>
        
      </li>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>
    <div class="to_top">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>
      </div>
    </main>
    
    <aside class="sidebar">
      
        <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="zdzhong"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">目录</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="http://shenyu-vip.lofter.com" target="_blank" rel="noopener">摄影</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2019/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
      </aside>
      
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>


  
<script src="/fancybox/jquery.fancybox.min.js"></script>




  
<script src="/js/tocbot.min.js"></script>

  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script>
  var ayerConfig = {
    mathjax: true
  }
</script>


<script src="/js/ayer.js"></script>



  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  </div>
</body>

</html>